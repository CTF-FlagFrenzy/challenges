# Corrupted File Writeup

This challenge provides the user with a file that has a corrupted signature. The task is to identify the corruption, correct the file signature, and extract the contents to find the hidden flag.

## Steps to Solve the Challenge:

1. **Identify the Corruption:**
   - The provided file has its first two bytes altered from `0x1f 0x8b` (the signature for a gzip file) to `0x00 0x00`.
   - Use a hex editor or a similar tool to inspect the first few bytes of the file.

2. **Correct the File Signature:**
   - Change the first two bytes back to `0x1f 0x8b` to restore the gzip file signature.
   - This can be done using a hex editor or a Python script.

3. **Extract the Contents:**
   - Once the file signature is corrected, use a tool like `tar` to extract the contents of the tar.gz archive.
   - The extracted file will contain the flag.

### Example Python Script to Correct the File Signature:

```python
import os

def correct_file_signature(file_path):
    try:
        if not os.path.isfile(file_path):
            raise FileNotFoundError(f"The file '{file_path}' does not exist.")
        
        with open(file_path, 'r+b') as f:
            f.seek(0)  # Move to the beginning of the file
            f.write(b'\x1f\x8b')  # Write the correct gzip signature
        print(f"File signature corrected for: {file_path}")
    except Exception as e:
        print(f"An error occurred: {e}")

# Usage
# Replace 'document' with the actual file path
correct_file_signature('document')
```

### Extracting the Contents:

After correcting the file signature, you can extract the contents using the following command:

```sh
tar -xzf document
```

This will extract the `flag.txt` file containing the flag.

---

## Backend Implementation

The backend for this challenge is implemented using Python and FastAPI. The following steps outline how the corrupted file is generated:

1. **Flag Generation:**
   - The flag is generated by combining a `TEAMKEY` (provided via environment variables) and a hardcoded `CHALLENGE` key.
   - The combined string is hashed using SHA-256 to produce the flag in the format `FF{<hash>}`.

2. **File Creation and Corruption:**
   - The flag is written to a `flag.txt` file.
   - The file is compressed into a `tar.gz` archive named `document`.
   - The first two bytes of the archive (`0x1f 0x8b`) are replaced with `0x00 0x00` to corrupt the file signature.

3. **File Delivery:**
   - The corrupted file is served via a FastAPI endpoint (`/`) using `FileResponse`.

### Debugging Options

The backend includes a debugging mode that can be enabled by setting the `DEBUG` environment variable to `True`. When enabled, the following information is printed to the console:
- The `TEAMKEY` and `CHALLENGE` key.
- The generated flag.

This can help users understand the flag generation process if they encounter difficulties solving the challenge.

---

**HAVE FUN**

> [!NOTE]
> If you have any problems solving this challenge, you can find a full guide [here](https://github.com/CTF-FlagFrenzy/challenges/blob/main/Corrupted_File/writeup.md)